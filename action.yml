name: "Deploy Front-end"
description: "Build and deploys a versioned front-end of an application to an AWS S3 bucket"
inputs:
  app-name:
    description: "Name of application"
    required: true
  aws-access-key-id:
    description: "AWS access key ID"
    required: true
  aws-access-key-secret:
    description: "AWS access key secret"
    required: true
  aws-s3-bucket:
    description: "Name of AWS S3 bucket"
    required: true
  aws-region:
    description: "AWS region for S3 bucket"
    default: eu-west-1
    required: true
  version:
    description: "Version to release; derived from tag name by default"
    required: true
    default: ${GITHUB_REF#refs/tags/}

runs:
  using: "composite"

  steps:
    - name: Validate version 👁
      shell: bash
      run: |
        SEMVER_REGEX="^(0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)\\.(0|[1-9][0-9]*)(\\-[0-9A-Za-z-]+(\\.[0-9A-Za-z-]+)*)?(\\+[0-9A-Za-z-]+(\\.[0-9A-Za-z-]+)*)?$"
        if [[ ! ${{ inputs.version }} =~ $SEMVER_REGEX ]];
          echo 'Version is not Semver (https://semver.org/) compliant' 
          exit 1
        fi

    - name: Checkout ⏬
      uses: actions/checkout@v2

    - name: Define Yarn 🧶 cache
      id: yarn-cache
      shell: bash
      run: echo "::set-output name=dir::$(yarn cache dir)"

    - name: Activate Yarn 🧶 cache
      uses: actions/cache@v2
      with:
        path: ${{ steps.yarn-cache.outputs.dir }}
        key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-yarn-

    - name: Set up Node ⬢
      uses: actions/setup-node@v2
      with:
        node-version: "16.x"

    - name: Install dependencies ⏬
      shell: bash
      run: yarn install --frozen-lockfile

    - name: Build 💪
      shell: bash
      run: yarn run build

    - name: Configure AWS Credentials 👮‍♀️
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-secret-access-key: ${{ inputs.aws-access-key-secret }}
        aws-region: ${{ inputs.aws-region }}

    - name: Copy files to S3 bucket 🔄
      shell: bash
      run: aws s3 sync ./dist/ s3://${{ inputs.aws-s3-bucket }}/${{ inputs.app-name }}/${{ inputs.version }}/
